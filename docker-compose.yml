# Development/testing compose - builds and runs app in Docker
# Usage: bun run docker:dev

services:
  muninn:
    build:
      context: .
      network: host
    network_mode: host
    volumes:
      - ./src:/app/src:ro
      - ./data:/app/data
      - ./dist:/app/dist
      - ./certs:/app/certs:ro
    environment:
      - NODE_ENV=development
      - PORT=3000
      - DATA_DIR=/app/data
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - SESSION_SECRET=${SESSION_SECRET}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - WHISPER_URL=${WHISPER_URL:-http://localhost:9000}
      - USE_TLS=true
      - TLS_CERT_PATH=/app/certs/server.crt
      - TLS_KEY_PATH=/app/certs/server.key
    # Rebuild client assets on startup, then run with watch
    command: sh -c "bun build src/client/main.tsx --outdir=dist/client/assets && bun --watch src/index.ts"
    stdin_open: true
    tty: true
